<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nhập Hóa Đơn Bằng Giọng Nói</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .pulse-animation { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
    </style>
</head>
<body class="bg-gradient-to-br from-green-50 to-emerald-100 min-h-screen p-4">
    <div class="max-w-2xl mx-auto">
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">Nhập Hóa Đơn Bằng Giọng Nói</h1>
            <p class="text-gray-600">Nói thông tin hóa đơn để tự động nhập vào hệ thống</p>
        </div>

        <!-- Voice Input Card -->
        <div class="bg-white rounded-xl shadow-lg p-8 mb-6">
            <div class="text-center mb-6">
                <div id="micIcon" class="w-24 h-24 mx-auto bg-red-500 rounded-full flex items-center justify-center text-xl text-white mb-4 cursor-pointer transition-all" onclick="toggleRecording()">
                    MIC
                </div>
                <div id="status" class="text-lg font-medium text-gray-700">Nhấn microphone để bắt đầu</div>
            </div>

            <!-- Voice Text Display -->
            <div class="bg-gray-50 rounded-lg p-4 mb-6 min-h-24">
                <div class="text-sm text-gray-500 mb-2">Văn bản nhận diện:</div>
                <div id="voiceText" class="text-gray-800 font-medium">Chưa có dữ liệu...</div>
            </div>

            <!-- Instructions -->
            <div class="bg-blue-50 rounded-lg p-4 mb-6">
                <div class="text-sm font-medium text-blue-800 mb-2">Hướng dẫn nói:</div>
                <div class="text-sm text-blue-700 space-y-1">
                    <div>• "Hôm nay tôi mua đồ ăn hết 50 nghìn"</div>
                    <div>• "Tôi chi tiền ăn uống 100k"</div>
                    <div>• "Mua sắm quần áo 200 nghìn đồng"</div>
                    <div>• "Đi xem phim giải trí 150k"</div>
                    <div>• "Mua nhà hết 2 triệu"</div>
                    <div>• "Chi tiền du lịch 5 triệu đồng"</div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex gap-3">
                <button id="processBtn" class="flex-1 bg-green-500 text-white py-3 px-6 rounded-lg hover:bg-green-600 disabled:bg-gray-300 disabled:cursor-not-allowed" onclick="processVoice()" disabled>
                    Xử Lý Thông Tin
                </button>
                <button onclick="clearVoice()" class="bg-gray-500 text-white py-3 px-6 rounded-lg hover:bg-gray-600">
                    Xóa
                </button>
            </div>
        </div>

        <!-- Results Card -->
        <div id="resultsCard" class="bg-white rounded-xl shadow-lg p-8 hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Thông Tin Hóa Đơn</h2>
            <div id="results" class="space-y-4"></div>
            
            <div class="flex gap-3 mt-6">
                <button id="saveBtn" class="flex-1 bg-blue-500 text-white py-3 px-6 rounded-lg hover:bg-blue-600" onclick="saveExpense()">
                    Lưu Chi Tiêu
                </button>
                <button onclick="window.location.href='index.html'" class="bg-gray-500 text-white py-3 px-6 rounded-lg hover:bg-gray-600">
                    Về Trang Chủ
                </button>
            </div>
        </div>
    </div>

    <script>
        let recognition = null;
        let isRecording = false;
        let voiceText = '';
        let currentData = null;

        // Kiểm tra hỗ trợ Speech Recognition
        if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
            document.getElementById('status').textContent = 'Trình duyệt không hỗ trợ nhận diện giọng nói!';
            document.getElementById('micIcon').style.backgroundColor = '#gray-500';
        }

        function toggleRecording() {
            if (isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        }

        function startRecording() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            
            recognition.lang = 'vi-VN';
            recognition.continuous = true;
            recognition.interimResults = true;
            
            recognition.onstart = () => {
                isRecording = true;
                document.getElementById('status').textContent = 'Đang nghe... Hãy nói thông tin hóa đơn';
                document.getElementById('micIcon').classList.add('pulse-animation');
                document.getElementById('micIcon').style.backgroundColor = '#ef4444';
            };
            
            recognition.onresult = (event) => {
                let finalTranscript = '';
                let interimTranscript = '';
                
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript;
                    } else {
                        interimTranscript += transcript;
                    }
                }
                
                voiceText = finalTranscript || interimTranscript;
                document.getElementById('voiceText').textContent = voiceText || 'Đang nghe...';
                
                if (finalTranscript) {
                    document.getElementById('processBtn').disabled = false;
                }
            };
            
            recognition.onerror = (event) => {
                console.error('Lỗi nhận diện:', event.error);
                document.getElementById('status').textContent = 'Lỗi: ' + event.error;
                stopRecording();
            };
            
            recognition.start();
        }

        function stopRecording() {
            if (recognition) {
                recognition.stop();
            }
            isRecording = false;
            document.getElementById('status').textContent = 'Đã dừng nghe';
            document.getElementById('micIcon').classList.remove('pulse-animation');
            document.getElementById('micIcon').style.backgroundColor = '#6b7280';
            
            if (voiceText) {
                document.getElementById('processBtn').disabled = false;
            }
        }

        function processVoice() {
            if (!voiceText) {
                alert('Chưa có dữ liệu giọng nói!');
                return;
            }
            
            console.log('Processing voice text:', voiceText);
            currentData = parseVoiceToReceipt(voiceText);
            console.log('Parsed data:', currentData);
            displayResults(currentData);
        }

        function parseVoiceToReceipt(text) {
            const lowerText = text.toLowerCase();
            
            // Nhận diện danh mục từ câu nói
            const categoryKeywords = {
                'Ăn uống': ['ăn', 'uống', 'đồ ăn', 'thức ăn', 'cơm', 'phở', 'bún', 'bánh', 'nước', 'cafe', 'trà', 'bia', 'rượu', 'nhà hàng', 'quán', 'buffet'],
                'Mua sắm': ['mua sắm', 'shopping', 'quần áo', 'giày', 'túi', 'đồ dùng', 'mỹ phẩm', 'trang sức', 'đồ gia dụng'],
                'Giải trí': ['giải trí', 'xem phim', 'karaoke', 'game', 'du lịch', 'vui chơi', 'thể thao', 'gym', 'massage'],
                'Di chuyển': ['xe', 'taxi', 'grab', 'xăng', 'dầu', 'vé', 'tàu', 'máy bay', 'xe buýt', 'gửi xe'],
                'Y tế': ['thuốc', 'bệnh viện', 'khám', 'chữa', 'y tế', 'sức khỏe', 'nha khoa'],
                'Học tập': ['học', 'sách', 'vở', 'bút', 'học phí', 'khóa học', 'giáo dục'],
                'Nhà cửa': ['nhà', 'điện', 'nước', 'gas', 'internet', 'thuê nhà', 'sửa chữa'],
                'Khác': []
            };
            
            let detectedCategory = 'Khác';
            let maxMatches = 0;
            
            for (const [category, keywords] of Object.entries(categoryKeywords)) {
                let matches = 0;
                for (const keyword of keywords) {
                    if (lowerText.includes(keyword)) {
                        matches++;
                    }
                }
                if (matches > maxMatches) {
                    maxMatches = matches;
                    detectedCategory = category;
                }
            }
            
            // Tìm số tiền
            let total = 0;
            
            // Tìm số tiền trong câu - TÌM TRIỆU TRƯỚC KHI REPLACE
            console.log('Original text:', lowerText);
            
            // Tìm số với đơn vị triệu TRƯỚC KHI replace
            const millionMatch = lowerText.match(/(\d+)\s*(?:triệu)/i);
            if (millionMatch) {
                let amount = parseInt(millionMatch[1]) * 1000000;
                total = Math.max(total, amount);
                console.log('Found million:', amount);
            }
            
            // Chuyển đổi số bằng chữ thành số (KHÔNG replace triệu nữa)
            let processedText = lowerText
                .replace(/một/g, '1')
                .replace(/hai/g, '2')
                .replace(/ba/g, '3')
                .replace(/bốn/g, '4')
                .replace(/năm/g, '5')
                .replace(/sáu/g, '6')
                .replace(/bảy/g, '7')
                .replace(/tám/g, '8')
                .replace(/chín/g, '9')
                .replace(/mười/g, '10')
                .replace(/trăm/g, '00')
                .replace(/nghìn|ngàn/g, '000');
            
            console.log('Processed text:', processedText);
            
            // Tìm số với đơn vị nghìn/k
            const thousandMatch = processedText.match(/(\d+)\s*(?:k|nghìn|ngàn)/i);
            if (thousandMatch) {
                let amount = parseInt(thousandMatch[1]);
                if (amount < 1000) amount *= 1000;
                total = Math.max(total, amount);
                console.log('Found thousand:', amount);
            }
            
            // Tìm số với đơn vị đồng/đ
            const dongMatch = processedText.match(/(\d+)\s*(?:đồng|vnđ|vnd|đ)\b/i);
            if (dongMatch) {
                let amount = parseInt(dongMatch[1]);
                if (amount < 1000) amount *= 1000; // Tự động nhân 1000 nếu < 1000
                total = Math.max(total, amount);
                console.log('Found dong:', amount);
            }
            
            // Tìm số sau từ khóa tiền
            const moneyMatch = processedText.match(/(?:hết|chi|tiền|giá)\s*(\d+)/i);
            if (moneyMatch) {
                let amount = parseInt(moneyMatch[1]);
                if (amount < 1000) amount *= 1000; // Tự động nhân 1000 nếu < 1000
                total = Math.max(total, amount);
                console.log('Found money keyword:', amount);
            }
            
            // Tìm số lớn (4 chữ số trở lên)
            const bigNumberMatch = processedText.match(/(\d{4,})/g);
            if (bigNumberMatch) {
                for (const num of bigNumberMatch) {
                    const amount = parseInt(num);
                    total = Math.max(total, amount);
                    console.log('Found big number:', amount);
                }
            }
            
            console.log('Final total:', total);
            
            return {
                category: detectedCategory,
                amount: total,
                description: `Chi tiêu ${detectedCategory.toLowerCase()} - Nhập bằng giọng nói`,
                date: new Date().toISOString().split('T')[0]
            };
        }

        function displayResults(data) {
            const html = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-green-50 p-6 rounded-lg text-center">
                        <div class="text-sm font-medium text-green-600 mb-2">Danh Mục</div>
                        <div class="text-2xl font-bold text-green-800">${data.category}</div>
                    </div>
                    <div class="bg-blue-50 p-6 rounded-lg text-center">
                        <div class="text-sm font-medium text-blue-600 mb-2">Số Tiền</div>
                        <div class="text-2xl font-bold text-blue-800">${formatCurrency(data.amount)}</div>
                    </div>
                </div>
                <div class="bg-gray-50 p-4 rounded-lg mt-4">
                    <div class="text-sm font-medium text-gray-600 mb-2">Mô Tả</div>
                    <div class="text-gray-800">${data.description}</div>
                </div>
            `;
            
            document.getElementById('results').innerHTML = html;
            document.getElementById('resultsCard').classList.remove('hidden');
        }
        
        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN').format(amount) + ' ₫';
        }

        async function saveExpense() {
            if (!currentData || !currentData.amount) {
                alert('Không có thông tin để lưu!');
                return;
            }
            
            const token = localStorage.getItem('token');
            if (!token) {
                alert('Vui lòng đăng nhập trước!');
                window.location.href = 'index.html';
                return;
            }
            
            try {
                // Tìm hoặc tạo danh mục
                const API_URL = (location.hostname === 'localhost' || location.hostname === '127.0.0.1' || location.hostname === '0.0.0.0') 
                  ? 'http://localhost:5000/api' 
                  : 'https://ltm-04.onrender.com/api';
                
                // Lấy danh sách danh mục hiện có
                const categoriesResponse = await fetch(`${API_URL}/danh-muc`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                let categoryId = null;
                if (categoriesResponse.ok) {
                    const categories = await categoriesResponse.json();
                    const existingCategory = categories.find(cat => 
                        cat.ten_danh_muc.toLowerCase() === currentData.category.toLowerCase() && 
                        cat.loai_danh_muc === 'Chi tiêu'
                    );
                    
                    if (existingCategory) {
                        categoryId = existingCategory.id;
                    } else {
                        // Tạo danh mục mới
                        const createCategoryResponse = await fetch(`${API_URL}/danh-muc`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify({
                                loai_danh_muc: 'Chi tiêu',
                                ten_danh_muc: currentData.category,
                                mo_ta: `Danh mục ${currentData.category} tự động tạo từ giọng nói`
                            })
                        });
                        
                        if (createCategoryResponse.ok) {
                            const newCategory = await createCategoryResponse.json();
                            categoryId = newCategory.id;
                        }
                    }
                }
                
                // Lưu giao dịch
                const transactionData = {
                    so_tien: currentData.amount,
                    mo_ta: currentData.description
                };
                
                if (categoryId) {
                    transactionData.danh_muc_id = categoryId;
                }
                
                const response = await fetch(`${API_URL}/giao-dich`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(transactionData)
                });
                
                if (response.ok) {
                    alert(`Đã lưu chi tiêu ${currentData.category} thành công!`);
                    document.getElementById('saveBtn').disabled = true;
                    document.getElementById('saveBtn').textContent = 'Đã lưu';
                } else {
                    const error = await response.json();
                    alert(`Lỗi: ${error.message}`);
                }
            } catch (error) {
                console.error('Lỗi:', error);
                alert('Không thể kết nối server!');
            }
        }

        function clearVoice() {
            voiceText = '';
            currentData = null;
            document.getElementById('voiceText').textContent = 'Chưa có dữ liệu...';
            document.getElementById('processBtn').disabled = true;
            document.getElementById('resultsCard').classList.add('hidden');
            document.getElementById('status').textContent = 'Nhấn microphone để bắt đầu';
        }
    </script>
</body>
</html>